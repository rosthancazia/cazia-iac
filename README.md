
# AWS Docker Swarm Infrastructure (IaC)

This project provisions a highly available **Docker Swarm** cluster on AWS using **Terraform** for immutable infrastructure and **Ansible** for configuration and orchestration.

The architecture employs a **Network Load Balancer (NLB)** for traffic ingress and places nodes within private subnets for enhanced security. Administrative access is securely managed via a **Bastion Host**.

## üèó Architecture

The diagram below illustrates the network topology and data flow:

```mermaid
graph TD
    user((Internet User))
    admin((Admin / Ansible))

    subgraph AWS [AWS Cloud (us-east-1)]
        style AWS fill:#f9f9f9,stroke:#333,stroke-width:2px

        subgraph VPC [VPC (10.0.0.0/16)]
            style VPC fill:#e1f5fe,stroke:#0277bd,stroke-dasharray: 5 5

            subgraph Public_Zone [Public Subnets]
                style Public_Zone fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
                
                NLB[AWS Network Load Balancer<br/>(TCP 80 / 443)]
                Bastion[Bastion Host<br/>Ubuntu 22.04<br/>Port: 60022]
                NAT[NAT Gateway]
            end

            subgraph Private_Zone [Private Subnets]
                style Private_Zone fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
                
                subgraph Swarm_Managers [Managers]
                    M1[Manager 01]
                    M2[Manager 02]
                    M3[Manager 03]
                end

                subgraph Swarm_Workers [Workers]
                    W1[Worker 01]
                    W2[Worker 02]
                end
            end
        end
    end

    %% Public Traffic Flow
    user ==>|HTTPS / 443| NLB
    NLB -->|TCP Pass-through| M1
    NLB -->|TCP Pass-through| W1

    %% Administrative Flow (SSH)
    admin -->|SSH -p 60022| Bastion
    Bastion -.->|SSH Proxy| M1
    Bastion -.->|SSH Proxy| W1

    %% Outbound Flow (Internet for Updates)
    M1 -.->|Outbound| NAT
    W1 -.->|Outbound| NAT

    %% Color Legend
    classDef public fill:#dcedc8,stroke:#33691e,stroke-width:2px;
    classDef private fill:#ffccbc,stroke:#bf360c,stroke-width:2px;
    classDef lb fill:#b3e5fc,stroke:#01579b,stroke-width:2px;
    
    class NLB,Bastion,NAT public;
    class M1,M2,M3,W1,W2 private;
    class NLB lb;
```

## üìÇ Project Structure

```text
.
‚îú‚îÄ‚îÄ main.tf                 # Terraform: Creates VPC, EC2, NLB, and generates Inventory
‚îú‚îÄ‚îÄ variables.tf            # (Optional) Terraform variables
‚îú‚îÄ‚îÄ inventory.ini           # Automatically generated by Terraform
‚îú‚îÄ‚îÄ swarm_vars.yml          # Traefik configuration variables (Email/Domain)
‚îú‚îÄ‚îÄ playbook.yml            # Ansible: Installs Docker and Configures the Swarm Cluster
‚îú‚îÄ‚îÄ deploy_traefik.yml      # Ansible: Deploys Traefik Stack with SSL
‚îú‚îÄ‚îÄ validate_swarm.yml      # Ansible: Cluster QA/Health checks
‚îú‚îÄ‚îÄ traefik-stack.yml.j2    # Jinja2 Template for Traefik Docker Stack
‚îî‚îÄ‚îÄ chave-cazia.pem         # Generated SSH Key (Ignored in Git)
```

## üöÄ Prerequisites

  * **Terraform** \>= 1.0
  * **Ansible** \>= 2.10
  * **AWS CLI** configured (`aws configure`)
  * Ansible Docker Collection:
    ```bash
    ansible-galaxy collection install community.docker
    ```

## üõ†Ô∏è Usage

### 1\. Provision Infrastructure (Terraform)

Terraform will create the network, virtual machines, Load Balancer, and trigger Ansible to install Docker and initialize the cluster.

```bash
# Initialize plugins
terraform init

# Create infrastructure and run initial setup
terraform apply -auto-approve
```

> **Note:** This process may take a few minutes. Terraform will wait for the NAT Gateway creation and VM initialization before running Ansible via the `null_resource`.

### 2\. DNS Configuration

At the end of `terraform apply`, you will receive an output containing the Load Balancer DNS.

```text
nlb_dns_name = "swarm-nlb-xxxx.elb.us-east-1.amazonaws.com"
```

Create a **CNAME** record in your domain provider pointing to this address:

  * `*.yourdomain.com` -\> `swarm-nlb-xxxx...`

### 3\. Deploy Traefik (Ingress Controller)

Edit the `swarm_vars.yml` file with your information:

```yaml
traefik_acme_email: "admin@yourdomain.com"
base_domain: "yourdomain.com"
```

Run the playbook to launch Traefik with **Let's Encrypt** support:

```bash
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i inventory.ini deploy_traefik.yml
```

### 4\. Validate the Cluster

To ensure everything is working correctly (Managers, Workers, and Overlay Network):

```bash
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i inventory.ini validate_swarm.yml
```

## üîê Access and Security

  * **SSH:** Direct access to nodes is blocked. Access is performed via the **Bastion Host** on port **60022**.
      * The key `chave-cazia.pem` is generated in the project root.
      * Ansible automatically configures the `ProxyCommand` in `inventory.ini`.
  * **SSL/TLS:** The NLB operates at Layer 4 (TCP). Traefik receives the encrypted traffic and automatically generates SSL certificates via Let's Encrypt.

## üßπ Teardown

To remove all AWS resources and avoid costs:

```bash
terraform destroy -auto-approve
```