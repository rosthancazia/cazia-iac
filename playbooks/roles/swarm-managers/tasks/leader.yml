---
    - name: üîç Check if Swarm has already been initialized
      community.docker.docker_swarm_info:
      register: swarm_status

    # 2. Inicializar o Swarm
    - name: üöÄ Initialize new Docker Swarm Leader
      # Usa o m√≥dulo docker_swarm, que √© idempotente
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ inventory_hostname }}"
      when:
        - inventory_hostname == groups['swarm_managers'][0]
        - not swarm_status.swarm_info.node_id # Inicializa se o n√≥ n√£o estiver no Swarm
      run_once: true

    # 3. Obter os Tokens
    # Esta tarefa agora √© simplificada, pois o m√≥dulo docker_swarm_info pode buscar os tokens.
    # No entanto, vamos obter os tokens explicitamente do l√≠der (primeiro n√≥) para garantir.
    - name: üîë Get Swarm join-tokens from the Leader
      community.docker.docker_swarm_info:
        # A API do Docker requer privil√©gios de root, mas o m√≥dulo lida com isso se become: true estiver no host.
        token: true
      register: swarm_tokens
      when: inventory_hostname == groups['swarm_managers'][0]
      run_once: true
      delegate_to: "{{ groups['swarm_managers'][0] }}"
      # O resultado 'swarm_tokens' agora estar√° dispon√≠vel para todos os n√≥s.

    # 4. Juntar Managers Secund√°rios (A√ß√£o no grupo 'swarm_managers', exceto o l√≠der)
    - name: ü§ù Join secondary Managers to the Swarm
      community.docker.docker_swarm:
        state: join
        join_token: "{{ hostvars[groups['swarm_managers'][0]]['swarm_tokens']['swarm_info']['join_tokens']['manager'] }}"
        remote_addr: "{{ groups['swarm_managers'][0] }}"
      when:
        - inventory_hostname != groups['swarm_managers'][0]
        - not swarm_status.swarm_info.node_id
