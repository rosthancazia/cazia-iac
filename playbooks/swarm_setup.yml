- name: ğŸ‹ Initialize Swarm and Join Managers
  hosts: swarm_managers
  become: true 
  vars:
    swarm_leader: "{{ groups['swarm_managers'][0] }}"
    leader_private_ip: "{{ hostvars[groups['swarm_managers'][0]]['ansible_host'] }}"

  tasks:
    # --- Leader Operations ---
    - name: ğŸ” Check Swarm Status
      community.docker.docker_swarm_info:
      register: swarm_status
      ignore_errors: true

    - name: ğŸš€ Initialize Docker Swarm Leader (If not initialized)
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
      when: 
        - inventory_hostname == swarm_leader
        - not swarm_status.swarm_info.node_id is defined
      register: swarm_init_result

    # ğŸ”‘ Recapture Swarm Info to Get Join Tokens (FIX APPLIED HERE)
    - name: ğŸ”‘ Recapture Swarm Info to Get Join Tokens
      community.docker.docker_swarm_info:
        # **FIX: Removed 'token: true' as it is unsupported/deprecated**
        # The join tokens are now returned by default in the swarm_info structure
      register: swarm_tokens
      delegate_to: "{{ swarm_leader }}" 
      run_once: true
      when: inventory_hostname == swarm_leader
      
    # --- Secondary Manager Joining (Logic remains the same) ---
    - name: ğŸ¤ Join secondary Managers to the Swarm
      community.docker.docker_swarm:
        state: join
        advertise_addr: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
        join_token: "{{ hostvars[swarm_leader]['swarm_tokens']['swarm_info']['join_tokens']['manager'] }}"
        remote_addrs: [ "{{ leader_private_ip }}:2377" ]
      when:
        - inventory_hostname != swarm_leader
        - not swarm_status.swarm_info.node_id is defined | default(false)
# ==============================================================================
# PLAY 3: WORKER JOINING
# ==============================================================================
- name: ğŸ‘· Join Workers to Swarm
  hosts: workers
  become: true
  vars:
    swarm_leader: "{{ groups['swarm_managers'][0] }}"
    leader_private_ip: "{{ hostvars[groups['swarm_managers'][0]]['ansible_host'] }}"

  tasks:
    - name: ğŸ” Check Swarm Status
      community.docker.docker_swarm_info:
      register: worker_swarm_status
      ignore_errors: true

    - name: ğŸ‘· Join Swarm as Worker
      community.docker.docker_swarm:
        state: join
        advertise_addr: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
        # Retrieve worker token from the leader's hostvars
        join_token: "{{ hostvars[swarm_leader]['swarm_tokens']['swarm_info']['join_tokens']['worker'] }}"
        # Use the leader's private IP for the remote connection
        remote_addrs: [ "{{ leader_private_ip }}:2377" ]
      when: not worker_swarm_status.swarm_info.node_id is defined