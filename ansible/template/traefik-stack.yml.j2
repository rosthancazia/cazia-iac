version: "3.8" # Manter 3.8 para compatibilidade Swarm

services:
  traefik:
    image: traefik:latest # Usando a versão mais recente
    networks:
      - traefik-public # Nome da nossa rede overlay
    ports:
      # Exposição de portas em modo HOST (essencial para NLB e performance)
      - target: 80
        published: 80
        mode: host
        protocol: tcp
      - target: 443
        published: 443
        mode: host
        protocol: tcp
      - target: 443
        published: 443
        mode: host
        protocol: udp # HTTP/3

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Volume persistente para certificados ACME
      - traefik-certificates:/certificates

    # Traefik Static configuration via command-line arguments
    command:
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # Providers
      - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
      - "--providers.swarm.network=traefik-public"
      - "--providers.swarm.exposedbydefault=false"
      - "--providers.swarm.watch=true"
      
      # Let's Encrypt (ACME) Configuration
      - "--certificatesresolvers.le.acme.email={{ traefik_acme_email }}"
      - "--certificatesresolvers.le.acme.storage=/certificates/acme.json"
      #- "--certificatesresolvers.le.acme.tlschallenge=true"
      - "--certificatesresolvers.leresolver.acme.httpchallenge=true" 
      # E defina o Entrypoint usado para o desafio (web = porta 80)
      - "--certificatesresolvers.leresolver.acme.httpchallenge.entrypoint=web"
      
      # Proxy Protocol & Forwarded Headers (Para o NLB)
      - "--entrypoints.web.proxyProtocol.trustedIPs={{ trusted_ip_range }}"
      - "--entrypoints.web.forwardedHeaders.trustedIPs={{ trusted_ip_range }}"
      - "--entrypoints.websecure.proxyProtocol.trustedIPs={{ trusted_ip_range }}"
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs={{ trusted_ip_range }}"

      # Protocolos
      - "--entrypoints.websecure.http3=true"
      - "--entrypoints.websecure.http.tls=true"

      # API & Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      
      # Observability
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--metrics.prometheus=true"

    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager # Roda apenas em managers para acesso ao socket
      labels:
        - "traefik.enable=true"

        # 1. MIDDLEWARE: Basic Auth (Injetado via variáveis)
        # Atenção: {{ traefik_hashed_password }} já está escapado no swarm_vars.yml
        - "traefik.http.middlewares.dashboard-auth.basicauth.users={{ traefik_hashed_password }}"
        
        # 2. MIDDLEWARE: HTTP to HTTPS Redirection
        - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
        - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"

        # 3. ROUTER: DASHBOARD - HTTPS (Protegido por Basic Auth)
        - "traefik.http.routers.dashboard-https.rule=Host(`{{ dashboard }}.{{ base_domain }}`)"
        - "traefik.http.routers.dashboard-https.entrypoints=websecure"
        - "traefik.http.routers.dashboard-https.service=api@internal"
        - "traefik.http.routers.dashboard-https.tls=true"
        - "traefik.http.routers.dashboard-https.tls.certresolver=le"
        - "traefik.http.routers.dashboard-https.middlewares=dashboard-auth" # Aplica a Basic Auth

        # 4. ROUTER: DASHBOARD - HTTP (Redirecionamento)
        - "traefik.http.routers.dashboard-http.rule=Host(`{{ dashboard }}.{{ base_domain }}`)"
        - "traefik.http.routers.dashboard-http.entrypoints=web"
        - "traefik.http.routers.dashboard-http.middlewares=https-redirect"

        # 5. ROTA DE TESTE WHOAMI (Adaptada para usar o resolver 'le')
        - "traefik.http.routers.whoami-https.rule=Host(`{{ app_teste }}.{{ base_domain }}`)"
        - "traefik.http.routers.whoami-https.entrypoints=websecure"
        - "traefik.http.routers.whoami-https.tls=true"
        - "traefik.http.routers.whoami-https.tls.certresolver=le"
        - "traefik.http.services.whoami.loadbalancer.server.port=80"


  # Deploy the Whoami application
  whoami:
    image: traefik/whoami
    networks:
      - traefik-public
    deploy:
      labels:
        - "traefik.enable=true"
        # O serviço é exposto pelo Whoami router definido no Traefik
        - traefik.http.services.whoami.loadbalancer.server.port=80
        # Label de constraint do serviço para ser encontrado pelo Traefik
        - traefik.constraint-label=traefik-public

volumes:
  traefik-certificates:

networks:
  traefik-public:
    driver: overlay
    external: true