---
- name: üí£ RESET COMPLETO DO AMBIENTE DOCKER SWARM
  hosts: managers:workers
  become: true
  gather_facts: false

  tasks:
    - name: "1. Remover todos os Stacks e Servi√ßos (Gerenciadores e Workers)"
      shell: docker stack rm proxy || true
      ignore_errors: true
      # Remove qualquer outro stack se voc√™ tiver
      # shell: docker stack ls -q | xargs -r docker stack rm || true 
      # Esta tarefa √© essencialmente um 'wait_for' implicito para os servi√ßos.

    - name: "2. Parar e Remover todos os Cont√™ineres restantes (Geral)"
      shell: docker ps -aq | xargs -r docker rm -f || true
      # O '-r' evita erro se 'docker ps -aq' retornar vazio
      ignore_errors: true
      
    - name: "3. Remover todos os Volumes (ATEN√á√ÉO: Deleta todos os dados!)"
      shell: docker volume prune -f || true
      ignore_errors: true
      
    - name: "4. Remover todas as Redes n√£o usadas (Incluindo Overlays)"
      shell: docker network prune -f || true
      ignore_errors: true

# # --- FASE DE ENCERRAMENTO DO SWARM (Managers e Workers) ---

# - name: 5. FOR√áAR N√ìS A SAIR DO CLUSTER SWARM
#   hosts: managers:workers
#   become: true
#   gather_facts: false
  
#   tasks:
#     - name: Deixar o Swarm (Workers e Managers)
#       # Usa --force em todos para garantir que mesmo o Manager L√≠der saia.
#       # O erro do Swarm ao sair ser√° ignorado se ele j√° tiver sa√≠do.
#       shell: docker swarm leave --force
#       register: swarm_leave_result
#       ignore_errors: true
      
#     - name: Exibir resultado da limpeza
#       debug:
#         msg: "Limpeza de n√≥ conclu√≠da. Sa√≠da do Swarm: {{ swarm_leave_result.stdout }}"