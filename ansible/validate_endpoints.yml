---
- name: üîé VALIDA√á√ÉO DE DISPONIBILIDADE DO TRAEFIK E ENDPOINTS
  hosts: localhost
  connection: local
  gather_facts: false

  # As vari√°veis 'base_domain', 'traefik_username', etc. s√£o injetadas
  # via '-e @swarm_vars.yml' no comando local-exec.
  vars:
    traefik_url: "https://traefik.{{ base_domain }}/dashboard/"
    whoami_url: "https://whoami.{{ base_domain }}"

  tasks:
    - name: Aguardar o NLB inicializar e o Traefik emitir o certificado SSL (Atraso inicial)
      pause:
        minutes: 1
      run_once: true

    - name: 1. Valida√ß√£o do Endpoint Whoami (Tentativas e Espera)
      ansible.builtin.uri:
        url: "{{ whoami_url }}"
        method: GET
        status_code: [200, 302] # 200 √© o ideal, 302 √© aceit√°vel
        validate_certs: false   # Permite testes mesmo com certificados em status tempor√°rio
        timeout: 20
      register: whoami_check
      # Tenta 20 vezes a cada 15 segundos (total de 5 minutos de espera)
      until: whoami_check.status == 200 or whoami_check.status == 302
      retries: 20
      delay: 15
      
    - name: Resultado da Valida√ß√£o Whoami
      assert:
        that: 
          - whoami_check.status == 200 or whoami_check.status == 302
        fail_msg: "‚ùå FALHA CR√çTICA: O endpoint {{ whoami_url }} n√£o est√° dispon√≠vel ou retornou erro (Status: {{ whoami_check.status }})."
        success_msg: "‚úÖ SUCESSO! O servi√ßo WHOAMI em {{ whoami_url }} est√° operacional."
    
    - name: 2. Valida√ß√£o do Dashboard Traefik (Verifica Basic Auth)
      ansible.builtin.uri:
        url: "{{ traefik_url }}"
        method: GET
        status_code: [401, 200] # Esperamos 401 Unauthorized, o que prova que a rota e o Basic Auth est√£o ativos.
        validate_certs: false
        timeout: 10
      register: traefik_check
      
    - name: Resultado da Valida√ß√£o Traefik Dashboard
      assert:
        that: 
          - traefik_check.status == 401 or traefik_check.status == 200
        fail_msg: "‚ùå FALHA CR√çTICA: O Dashboard Traefik em {{ traefik_url }} n√£o est√° respondendo como esperado (Status: {{ traefik_check.status }})."
        success_msg: "‚úÖ SUCESSO! O Dashboard Traefik est√° ativo e protegido (Status: {{ traefik_check.status }})."